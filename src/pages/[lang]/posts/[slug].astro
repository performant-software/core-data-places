---
import PostContent from "@apps/posts/PostContent";
import { getTranslations } from "@backend/i18n";
import { fetchPost, fetchPosts } from "@backend/tina";
import Container from "@components/Container.astro";
import config from "@config";
import { getLocalizedContent } from "@i18n/utils";
import Layout from "@layouts/Layout.astro";
import { hasPostsContent } from "@utils/config";
import _ from "underscore";

const { slug } = Astro.params;
const post = await fetchPost(slug);

const locale = Astro.currentLocale;

const localePost = getLocalizedContent(post, locale.replaceAll("-", "_")); //this is to deal with Tina's field naming restrictions

const { t } = await getTranslations(locale);

export const getStaticPaths = async () => {
  if (!hasPostsContent(config)) {
    return [];
  }

  const staticPaths = [];

  const locales = config.i18n.locales;
  const posts = await fetchPosts();

  _.each(locales, (lang) => {
    _.each(posts, (post) => {
      staticPaths.push({
        params: {
          lang,
          slug: post?._sys.filename,
        },
      });
    });
  });

  return staticPaths;
};
---

<Layout footer t={t} tab="posts" title={localePost?.title}>
  <Container className="pb-16 w-full">
    <PostContent
      content={post?.body}
      title={post?.title}
      author={post?.author}
      date={post?.date}
      client:only="react"
    />
  </Container>
</Layout>
